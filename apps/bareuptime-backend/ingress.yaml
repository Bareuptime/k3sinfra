---
# Middlewares for security, rate limiting, and CORS
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: security-headers
  namespace: bareuptime-backend
spec:
  headers:
    frameDeny: true
    contentTypeNosniff: true
    browserXssFilter: true
    referrerPolicy: "strict-origin-when-cross-origin"
    stsSeconds: 31536000
    stsIncludeSubdomains: true
    stsPreload: true
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: bareuptime-backend
spec:
  rateLimit:
    average: 200
    burst: 400
    period: 1m
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: api-rate-limit
  namespace: bareuptime-backend
spec:
  rateLimit:
    average: 100
    burst: 200
    period: 1m
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: cors-headers
  namespace: bareuptime-backend
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - OPTIONS
      - PUT
      - POST
      - DELETE
    accessControlAllowOriginList:
      - "https://*.bareuptime.co"
      - "https://bareuptime.co"
      - "https://*.bareuptime.online"
      - "https://bareuptime.online"
    accessControlAllowHeaders:
      - Accept
      - Authorization
      - Cache-Control
      - Content-Type
      - DNT
      - If-Modified-Since
      - Keep-Alive
      - Origin
      - User-Agent
      - X-Requested-With
    accessControlMaxAge: 86400
    addVaryHeader: true
---
# Certificate for api1.bareuptime.co
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: api-bareuptime-tls
  namespace: bareuptime-backend
spec:
  secretName: api-bareuptime-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - api1.bareuptime.co
---
# Certificate for mcp1.bareuptime.co
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: mcp-bareuptime-tls
  namespace: bareuptime-backend
spec:
  secretName: mcp-bareuptime-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - mcp1.bareuptime.co
---
# IngressRoute for api1.bareuptime.co
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: backend-api
  namespace: bareuptime-backend
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`api1.bareuptime.co`)
      kind: Rule
      priority: 100
      services:
        - name: backend
          port: 8080
      middlewares:
        - name: security-headers
        - name: rate-limit
        - name: cors-headers
  tls:
    secretName: api-bareuptime-tls
---
# IngressRoute for mcp1.bareuptime.co
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: backend-mcp
  namespace: bareuptime-backend
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`mcp1.bareuptime.co`)
      kind: Rule
      priority: 100
      services:
        - name: backend
          port: 8080
      middlewares:
        - name: security-headers
        - name: api-rate-limit
        - name: cors-headers
  tls:
    secretName: mcp-bareuptime-tls
---
# IngressRoute for wildcard subdomains (*.bareuptime.online)
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: backend-wildcard-subdomains
  namespace: bareuptime-backend
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`{subdomain:[a-z0-9-]+}.bareuptime.online`)
      kind: Rule
      priority: 50  # Lower than specific API domains, higher than catch-all
      services:
        - name: backend
          port: 8080
      middlewares:
        - name: security-headers
        - name: cors-headers
  tls:
    secretName: bareuptime-online-wildcard-tls
---
# IngressRoute for custom domains (catch-all)
# IMPORTANT: This must have the LOWEST priority to avoid interfering with API domains
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: backend-custom-domains
  namespace: bareuptime-backend
spec:
  entryPoints:
    - websecure
  routes:
    - match: HostRegexp(`{host:.+}`) && !Host(`api1.bareuptime.co`, `mcp1.bareuptime.co`)
      kind: Rule
      priority: 1  # LOWEST priority - catch-all for custom domains
      services:
        - name: backend
          port: 8080
      middlewares:
        - name: security-headers
        - name: cors-headers
  tls:
    # Use certResolver for dynamic certificate provisioning via HTTP-01
    certResolver: letsencrypt-prod
